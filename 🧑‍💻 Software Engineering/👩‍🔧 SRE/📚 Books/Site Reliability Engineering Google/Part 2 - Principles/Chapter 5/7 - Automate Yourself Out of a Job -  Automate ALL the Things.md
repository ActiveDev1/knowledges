**مطالعه موردی: پایگاه داده تبلیغات گوگل و اتوماسیون در SRE**

برای مدت طولانی، محصولات تبلیغاتی گوگل داده‌های خود را در یک پایگاه داده **MySQL** ذخیره می‌کردند. از آنجا که داده‌های تبلیغات به‌طور واضح نیاز به **قابلیت اطمینان بالا** دارند، یک تیم SRE مسئول مدیریت این زیرساخت بود. از سال 2005 تا 2008، پایگاه داده تبلیغات در حالتی که ما آن را **بالغ و مدیریت‌شده** می‌دانستیم، اجرا می‌شد. برای مثال، ما بدترین بخش‌های کارهای روتین برای تعویض استاندارد replicaها را خودکار کرده بودیم، اما نه همه آن‌ها. ما معتقد بودیم که پایگاه داده تبلیغات به‌خوبی مدیریت می‌شود و بیشتر فرصت‌های ساده برای بهینه‌سازی و مقیاس‌پذیری را بهره‌برداری کرده‌ایم. با این حال، با راحت‌تر شدن عملیات روزانه، اعضای تیم شروع به بررسی سطح بعدی توسعه سیستم کردند: **مهاجرت MySQL به سیستم زمان‌بندی کلاستر گوگل، یعنی Borg**.

ما امیدوار بودیم که این مهاجرت دو مزیت اصلی به همراه داشته باشد:

1. **حذف کامل نگهداری ماشین/replica**: Borg به‌طور خودکار راه‌اندازی/راه‌اندازی مجدد وظایف جدید یا خراب را مدیریت می‌کند.
2. **امکان bin-packing چند نمونه MySQL روی یک ماشین فیزیکی**: Borg با استفاده از کانتینرها، بهره‌وری بیشتری از منابع ماشین فراهم می‌کند.

در اواخر سال 2008، ما با موفقیت یک نمونه آزمایشی MySQL را روی Borg مستقر کردیم. اما این کار با یک مشکل جدید و قابل‌توجه همراه بود. یکی از ویژگی‌های اصلی Borg این است که وظایف آن به‌صورت خودکار جابه‌جا می‌شوند. وظایف معمولاً در Borg هفته‌ای یک یا دو بار جابه‌جا می‌شوند. این تکرر برای replicaهای پایگاه داده ما قابل‌تحمل بود، اما برای **masterها** غیرقابل‌قبول بود.

در آن زمان، فرآیند انتقال master (failover) برای هر نمونه 30 تا 90 دقیقه طول می‌کشید. از آنجا که ما روی ماشین‌های اشتراکی اجرا می‌شدیم و در معرض راه‌اندازی مجدد برای به‌روزرسانی کرنل بودیم، علاوه بر نرخ معمول خرابی ماشین‌ها، باید انتظار تعدادی انتقال غیرمرتبط در هر هفته را می‌داشتیم. این عامل، همراه با تعداد shardهای میزبانی‌شده سیستم ما، به این معنا بود که:

- انتقال‌های دستی مقدار قابل‌توجهی از ساعات انسانی را مصرف می‌کردند و در بهترین حالت، دسترس‌پذیری 99% را فراهم می‌کردند که از نیازهای واقعی کسب‌وکار محصول کمتر بود.
- برای رعایت بودجه خطا (error budget)، هر انتقال باید کمتر از 30 ثانیه قطعی (downtime) داشته باشد. بهینه‌سازی یک فرآیند وابسته به انسان برای کاهش قطعی به زیر 30 ثانیه غیرممکن بود.

بنابراین، تنها گزینه ما **خودکارسازی انتقال** بود. در واقع، ما نیاز داشتیم بیش از فقط انتقال را خودکار کنیم.

در سال 2009، تیم SRE تبلیغات **دیوایدر (Decider)** را تکمیل کرد، یک daemon خودکار که می‌توانست انتقال‌های MySQL را برای هر دو نوع انتقال برنامه‌ریزی‌شده و غیربرنامه‌ریزی‌شده در کمتر از 30 ثانیه در 95% موارد انجام دهد. با ایجاد Decider، اجرای MySQL روی Borg (MoB) سرانجام به واقعیت تبدیل شد. ما از بهینه‌سازی زیرساخت برای اجتناب از انتقال، به پذیرش این ایده که **شکست اجتناب‌ناپذیر است** و بنابراین بهینه‌سازی برای **بازیابی سریع از طریق اتوماسیون** تغییر کردیم.

در حالی که اتوماسیون به ما امکان داد MySQL با دسترس‌پذیری بالا را در دنیایی با حداکثر دو راه‌اندازی مجدد در هفته به دست آوریم، هزینه‌های خاص خود را نیز داشت. تمام برنامه‌های ما باید تغییر می‌کردند تا شامل **منطق مدیریت خطا** بسیار بیشتری نسبت به قبل شوند. با توجه به اینکه در دنیای توسعه MySQL فرض بر این است که نمونه MySQL پایدارترین جزء پشته است، این تغییر به این معن بود که نرم‌افزارهایی مانند JDBC باید برای محیط مستعد خطای ما سفارشی‌سازی شوند تا تحمل بیشتری داشته باشند. با این حال، مزایای مهاجرت به MoB با Decider ارزش این هزینه‌ها را داشت. پس از مهاجرت به MoB، زمان صرف‌شده توسط تیم ما برای کارهای عملیاتی روزمره **95% کاهش یافت**. انتقال‌ها خودکار شدند، بنابراین قطعی یک وظیفه پایگاه داده دیگر نیازی به پیج کردن انسان نداشت.

نتیجه اصلی این اتوماسیون جدید این بود که زمان زیادی برای بهبود سایر بخش‌های زیرساخت آزاد شد. این بهبودها اثر آبشاری داشتند: هرچه زمان بیشتری ذخیره می‌کردیم، زمان بیشتری برای بهینه‌سازی و خودکارسازی سایر کارهای خسته‌کننده داشتیم. در نهایت، ما توانستیم تغییرات اسکیما را خودکار کنیم، که باعث شد هزینه کل نگهداری عملیاتی پایگاه داده تبلیغات **نزدیک به 95% کاهش یابد**. برخی ممکن است بگویند که ما با موفقیت خودمان را از این شغل حذف کردیم. سمت سخت‌افزاری حوزه ما نیز بهبود یافت. مهاجرت به MoB منابع قابل‌توجهی را آزاد کرد، زیرا می‌توانستیم چندین نمونه MySQL را روی یک ماشین برنامه‌ریزی کنیم، که بهره‌وری سخت‌افزار ما را بهبود داد. در مجموع، حدود **60% از سخت‌افزارمان** آزاد شد. تیم ما حالا منابع سخت‌افزاری و مهندسی فراوانی داشت.

این مثال نشان‌دهنده حکمت تلاش اضافی برای ارائه یک **پلتفرم** به جای جایگزینی رویه‌های دستی موجود است. مثال بعدی از گروه زیرساخت کلاستر می‌آید و برخی از تعادل‌های دشوارتر را که ممکن است در مسیر خودکارسازی همه چیز با آن مواجه شوید، نشان می‌دهد.