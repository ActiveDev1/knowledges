**شاخص‌ها در عمل**

انتخاب معیارهای مناسب برای اندازه‌گیری سرویس بسیار مهم است، اما چگونه می‌توان معیارهای معنادار برای یک سرویس یا سیستم را شناسایی کرد؟

### چه چیزی برای شما و کاربرانتان مهم است؟
نباید هر معیاری که در سیستم **monitoring** قابل ردیابی است را به‌عنوان **SLI** (Service Level Indicator) استفاده کرد. درک نیازهای کاربران به انتخاب دقیق چند شاخص کلیدی کمک می‌کند. انتخاب تعداد زیاد SLI باعث پراکندگی توجه می‌شود، در حالی که تعداد کم ممکن است رفتارهای مهم سیستم را نادیده بگیرد. معمولاً چند شاخص نماینده برای ارزیابی و تحلیل سلامت سیستم کافی است.

سرویس‌ها معمولاً در چند دسته کلی قرار می‌گیرند و **SLI**های مرتبط با آن‌ها به شرح زیر است:
- **سیستم‌های serving کاربرمحور** (مثل frontend جست‌وجوی شکسپیر):
  - **Availability**: آیا به درخواست پاسخ داده شد؟
  - **Latency**: پاسخ چقدر طول کشید؟
  - **Throughput**: چند درخواست پردازش شد؟
- **سیستم‌های ذخیره‌سازی**:
  - **Latency**: خواندن یا نوشتن داده چقدر طول می‌کشد؟
  - **Availability**: آیا داده‌ها در زمان نیاز قابل دسترسی هستند؟
  - **Durability**: آیا داده‌ها در طولانی‌مدت حفظ می‌شوند؟ (رجوع به *Data Integrity: What You Read Is What You Wrote*).
- **سیستم‌های داده بزرگ** (مثل pipelineهای پردازش داده):
  - **Throughput**: چه مقدار داده پردازش می‌شود؟
  - **End-to-End Latency**: پردازش داده از دریافت تا تکمیل چقدر طول می‌کشد؟ (برخی pipelineها ممکن است برای مراحل خاص نیز هدف **latency** داشته باشند).
- **همه سیستم‌ها**:
  - **Correctness**: آیا پاسخ درست، داده صحیح یا تحلیل مناسب ارائه شد؟ **Correctness** برای ردیابی سلامت سیستم مهم است، حتی اگر معمولاً به داده‌های سیستم (نه زیرساخت) مربوط باشد و مسئولیت SRE نباشد.

### جمع‌آوری شاخص‌ها
بسیاری از **SLI**ها به‌طور طبیعی در سمت سرور با استفاده از سیستم‌های **monitoring** مثل **Borgmon** یا **Prometheus** یا تحلیل دوره‌ای **log**ها جمع‌آوری می‌شوند (مثلاً درصد پاسخ‌های HTTP 500 نسبت به کل درخواست‌ها). اما برخی سیستم‌ها نیاز به جمع‌آوری داده در سمت **client** دارند، زیرا عدم اندازه‌گیری رفتار در client می‌تواند مشکلاتی که کاربران تجربه می‌کنند (اما در معیارهای سرور دیده نمی‌شوند) را نادیده بگیرد. 
- **مثال**: تمرکز روی **latency** backend جست‌وجوی شکسپیر ممکن است مشکلات **latency** کاربر ناشی از JavaScript صفحه را نادیده بگیرد. در این مورد، اندازه‌گیری زمان لازم برای **usable** شدن صفحه در مرورگر، **proxy** بهتری برای تجربه کاربر است.

### تجمیع (Aggregation)
برای سادگی و کاربردی بودن، اغلب داده‌های خام تجمیع می‌شوند، اما این کار باید با دقت انجام شود:
- برخی معیارها به ظاهر ساده‌اند، مثل تعداد درخواست‌ها در ثانیه (**requests per second**)، اما حتی این معیار به‌طور ضمنی داده‌ها را در بازه اندازه‌گیری (**measurement window**) تجمیع می‌کند. مثلاً، آیا داده هر ثانیه جمع‌آوری می‌شود یا میانگین یک دقیقه است؟ میانگین یک دقیقه ممکن است **burst**های کوتاه با نرخ درخواست بالا را پنهان کند.
  - **مثال**: سیستمی که در ثانیه‌های زوج 200 درخواست و در ثانیه‌های فرد 0 درخواست پردازش می‌کند، میانگین 100 درخواست در ثانیه دارد، اما بار لحظه‌ای آن دو برابر میانگین است.
- میانگین **latency** درخواست‌ها ممکن است جذاب باشد، اما جزئیات مهم را پنهان می‌کند. مثلاً، ممکن است اکثر درخواست‌ها سریع باشند، اما تعداد کمی (**long tail**) بسیار کند باشند.
- معیارها بهتر است به صورت **توزیع** (distribution) دیده شوند تا میانگین. برای **latency SLI**، برخی درخواست‌ها سریع و برخی کندتر هستند. میانگین می‌تواند **tail latencies** را پنهان کند.
- ![[figure.4-1.png]]
  - **شکل 4-1**: نشان می‌دهد که اگرچه درخواست معمولی در 50 میلی‌ثانیه پاسخ داده می‌شود، 5% درخواست‌ها 20 برابر کندترند! اگر فقط میانگین **latency** رصد شود، تغییرات در **tail latency** (که در طول روز قابل‌توجه است) دیده نمی‌شود.

استفاده از **percentile**ها برای SLIها به درک شکل توزیع کمک می‌کند:
- **99th یا 99.9th percentile**: بدترین حالت معقول را نشان می‌دهد.
- **50th percentile (median)**: مورد معمولی را نشان می‌دهد.
- در سیستم‌هایی با **variance** بالا در زمان پاسخ، تجربه کاربر بیشتر تحت تأثیر **long tail** است، به‌ویژه در بار بالا به دلیل اثرات **queuing**. مطالعات نشان داده‌اند که کاربران یک سیستم کمی کندتر اما با **variance** کم را به سیستمی با **variance** بالا ترجیح می‌دهند. برخی تیم‌های SRE فقط روی **percentile**های بالا تمرکز می‌کنند، زیرا اگر رفتار 99.9th خوب باشد، تجربه معمولی قطعاً خوب است.

### نکته درباره خطاهای آماری
ترجیح ما استفاده از **percentile**ها به جای میانگین (mean) است، زیرا **long tail** داده‌ها را نشان می‌دهد که اغلب ویژگی‌های متفاوتی از میانگین دارند. در سیستم‌های محاسباتی، داده‌ها معمولاً **skewed** هستند (مثلاً، هیچ درخواستی نمی‌تواند زیر 0 میلی‌ثانیه باشد، و **timeout** در 1000 میلی‌ثانیه پاسخ‌های موفق را محدود می‌کند). بنابراین، نمی‌توان فرض کرد که میانگین و میانه (median) یکسان یا نزدیک به هم هستند.
- فرض توزیع نرمال (**normal distribution**) بدون تأیید خطرناک است. مثلاً، اگر توزیع غیرمنتظره باشد، فرایندی که برای **outlier**ها (مثل راه‌اندازی مجدد سرور با **latency** بالا) اقدام می‌کند، ممکن است بیش‌ازحد یا کمتر از حد لازم فعال شود.

### استانداردسازی شاخص‌ها
توصیه می‌کنیم **SLI**ها را با تعاریف استاندارد یکسان‌سازی کنید تا هر بار نیازی به استدلال از ابتدا نباشد. ویژگی‌هایی که با قالب‌های استاندارد مطابقت دارند، می‌توانند از تعریف SLI حذف شوند:
- **Aggregation intervals**: "میانگین در 1 دقیقه"
- **Aggregation regions**: "همه taskها در یک cluster"
- **فرکانس اندازه‌گیری**: "هر 10 ثانیه"
- **درخواست‌های شامل**: "HTTP GETها از jobهای **black-box monitoring**"
- **نحوه جمع‌آوری داده**: "از طریق **monitoring**، اندازه‌گیری‌شده در سرور"
- **Latency دسترسی به داده**: "زمان تا آخرین بایت"

برای صرفه‌جویی در تلاش، مجموعه‌ای از قالب‌های **SLI** قابل‌استفاده مجدد برای معیارهای رایج بسازید. این کار درک SLIهای خاص را برای همه ساده‌تر می‌کند.